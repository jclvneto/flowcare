flowchart TD
  %% ========= LEGEND =========
  L1([Tela]):::ui --> L2{{Decisão}}:::decision --> L3[[Processo]]:::proc --> L4((Evento)):::event
  classDef ui fill:#eef,stroke:#446;
  classDef decision fill:#ffe,stroke:#aa6;
  classDef proc fill:#efe,stroke:#494;
  classDef event fill:#fef,stroke:#646;
  classDef warn fill:#fee,stroke:#a66;
  classDef note fill:#fff,stroke:#bbb,stroke-dasharray: 3 3,color:#666;

  %% ========= ENTRYPOINTS =========
  START((Entradas)):::event --> EP1[Login / SSO]:::ui
  START --> EP2[WhatsApp (Cliente)]:::ui
  START --> EP3[Convite por e-mail (Admin)]:::ui

  EP1 --> A0{{Perfil do usuário?}}:::decision
  A0 -->|Admin_Master| AM1[Home Admin Master]:::ui
  A0 -->|Admin da Clínica| AC1[Home Admin Clínica]:::ui
  A0 -->|Recepcionista| R1[Home Recepção]:::ui
  A0 -->|Veterinário| V1[Home Veterinário]:::ui

  %% ========= PERFIL =========
  subgraph PERFIL[Perfil & Preferências]
    P0[Editar Perfil (nome, fuso, avatar, telefone)]:::ui
    P1[[Salvar perfil]]:::proc --> P2((OK)):::event
    P3{{WhatsApp Opt-in?}}:::decision
    P4[[Gerenciar dispositivos e 2FA]]:::proc
  end
  AM1 -.-> P0
  AC1 -.-> P0
  R1  -.-> P0
  V1  -.-> P0
  P0 --> P1 --> P2 --> P3
  P3 -->|Sim| P4
  P3 -->|Não| P4

  %% ========= ADMIN MASTER =========
  subgraph ADM_MASTER[Admin Master - Multi-tenant]
    AM1 --> AM2[Dashboard Global (KPIs gerais)]:::ui
    AM2 --> AM3[Gestão de Clínicas]:::ui
    AM3 --> AM3a[[Criar/Editar/Desativar Clínica]]:::proc --> AM3b((Clínica atualizada)):::event
    AM2 --> AM4[Gestão de Usuários Globais]:::ui
    AM4 --> AM4a[[Adicionar/Remover Usuários (vet/recep) em qualquer clínica]]:::proc --> AM4b((Usuário atualizado)):::event
  end

  %% ========= ADMIN CLÍNICA =========
  subgraph ADM_CLINICA[Admin da Clínica]
    AC1 --> AC2[Dashboard da Clínica (Consultas, NPS, Receita enviada)]:::ui
    AC2 --> AC3[Gestão de Usuários da Clínica]:::ui
    AC3 --> AC3a[[Add/Remove Vet/Recep (apenas da clínica)]]:::proc --> AC3b((Usuário atualizado)):::event
    AC2 --> AC4[Configurações da Clínica]:::ui
    AC4 --> AC4a[[WhatsApp number, FAQ base, Google Forms URL]]:::proc --> AC4b((Config salva)):::event
  end

  %% ========= RECEPÇÃO / AGENDA =========
  subgraph RECEPCAO[Recepção & Agendamento]
    R1 --> R2[Agenda Geral (por veterinário)]:::ui
    R1 --> R3[Inbox WhatsApp]:::ui
    R3 --> R3a{{Nova mensagem pede agendamento?}}:::decision
    R3a -->|Sim| R4[Propor horários → Criar pré-agendamento]:::ui
    R3a -->|Dúvida FAQ| R5[[Responder via FAQ / IA]]:::proc
    R3a -->|Escalonar| R6[[Encaminhar ao humano (recepção/vet)]]:::proc

    R4 --> R7{{Conflito de horário?}}:::decision
    R7 -->|Sim| R7a[Alertar conflito + sugerir slots próximos]:::ui:::warn --> R4
    R7 -->|Não| R8[[Salvar Agendamento PENDING]]:::proc --> R9((Notificar Cliente p/ Confirmação)):::event
    R2 -.-> R8
  end

  %% ========= WHATSAPP (CLIENTE) =========
  subgraph WHATSAPP[WhatsApp do Cliente (FAQ + Agendamento + Mensagens)]
    EP2 --> W0[Cliente envia mensagem]:::ui
    W0 --> W1{{Classificar intenção (IA)}}:::decision
    W1 -->|Agendar| W2[[Coletar preferências (dia/hora/vet)]]:::proc --> W3((Criar Thread/Atualizar)):::event --> R3
    W1 -->|Dúvida| W4[[Buscar FAQ (global/da clínica)]]:::proc --> W5{{Confiante?}}:::decision
    W5 -->|Sim| W6((Enviar resposta automática)):::event
    W5 -->|Não| W7[[Escalonar p/ Recepção]]:::proc --> R3
    W1 -->|Outros| W7
  end

  %% ========= VETERINÁRIO / CONSULTA & PRONTUÁRIO =========
  subgraph VET[Veterinário & Prontuário com Áudio/IA]
    V1 --> V2[Minha Agenda]:::ui
    V2 --> V3[Abrir Consulta (encontro)]:::ui
    V3 --> V4{{Permissão de microfone concedida?}}:::decision
    V4 -->|Não| V4a[Modal instruções + Tentar novamente / Modo Manual]:::ui:::warn
    V4 -->|Sim| V5[[Captura Áudio Contínua]]:::proc
    V5 --> V6[[Transcrição (OpenAI Whisper)]]:::proc
    V6 --> V7[[Estruturar campos do prontuário (IA NLP)]]:::proc
    V7 --> V8[Tela de Revisão do Prontuário]:::ui
    V8 --> V9{{Está completo e correto?}}:::decision
    V9 -->|Editar| V8
    V9 -->|Sim| V10[[Assinar/Confirmar Encontro]]:::proc --> V11((Encontro CONFIRMED)):::event
    V7 --> V12[Fallback Manual (campos editáveis)]:::ui:::note

    %% Prescrição
    V11 --> PR1[Gerar Prescrição]:::ui
    PR1 --> PR2[[Adicionar itens / dosagem / duração / via]]:::proc
    PR2 --> PR3{{Gerar PDF?}}:::decision
    PR3 -->|Sim| PR4[[Render PDF & Assinar Digital]]:::proc --> PR5((PDF pronto)):::event
    PR3 -->|Não| PR6((Mensagem estruturada)):::event

    %% Envio Pós-consulta
    PR5 --> S1[[Enviar via WhatsApp ao tutor]]:::proc
    PR6 --> S1
    S1 --> S2((Status: queued/sent/delivered/read/failed)):::event
    S2 --> S3{{Falha?}}:::decision
    S3 -->|Sim| S3a[Retentar + Log erro + Notificar recepção]:::ui:::warn
    S3 -->|Não| S4((OK)):::event

    %% Feedback
    V11 --> FB1[[Gerar link de Feedback (Google Forms)]]:::proc --> FB2((Enviar link por WhatsApp)):::event
  end

  %% ========= DASHBOARDS =========
  subgraph DASH[Dashboards]
    AM2 --> D0[KPIs Globais: nº clínicas, consultas, taxa no-show, satisfação]:::ui
    AC2 --> D1[KPIs Clínica: consultas, duração média, NPS, entregas WhatsApp]:::ui
    R2 --> D2[Indicadores Recepção: TMA, fila WhatsApp, confirmações]:::ui
    V2 --> D3[Indicadores Vet: produtividade, casos/dia, revisões pendentes]:::ui
  end

  %% ========= ENTIDADES PACIENTE/TUTOR =========
  subgraph CLIENTES[Cliente (Tutor) & Paciente]
    C1[Buscar/Registrar Tutor]:::ui --> C2[[Salvar Tutor]]:::proc
    C3[Buscar/Registrar Paciente]:::ui --> C4[[Salvar Paciente]]:::proc
    C4 --> C5((Vinculado à clínica e tutor)):::event
  end
  R1 -.-> C1
  R1 -.-> C3
  AC1 -.-> C1
  AC1 -.-> C3
  V1 -.-> C3

  %% ========= ESTADOS / EDGE CASES =========
  subgraph EDGE[Estados & Erros de UX]
    E1{{Conflito de agenda}}:::decision
    E2{{Cliente sem opt-in WhatsApp}}:::decision
    E3{{Áudio falhou / conexão}}:::decision
    E4{{Transcrição baixa confiança}}:::decision
    E5{{FAQ desatualizada}}:::decision

    E1 -->|Resolver| R7a
    E2 -->|Solicitar opt-in| W6
    E3 -->|Regravar / Modo Manual| V4a
    E4 -->|Destacar campos p/ revisão| V8
    E5 -->|Sugerir atualização p/ Admin Clínica| AC4
  end

  %% ========= VÍNCULOS WHATSAPP <-> AGENDA =========
  W3 --> R4
  R9 -->|Cliente confirma por WA| ACONF((Status: CONFIRMED)):::event --> R2
  R9 -->|Cliente cancela| ACAN((Status: CANCELLED)):::event --> R2

  %% ========= SAÍDAS =========
  S4 --> END((Consulta finalizada, receita enviada, feedback solicitado)):::event
  D0 -.-> END
  D1 -.-> END
